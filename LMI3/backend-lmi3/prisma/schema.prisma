generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int         @id @default(autoincrement())
  email     String      @unique
  name      String?
  createdAt DateTime    @default(now())
  password  String
  phone     String?
  salt      String
  type      Int         @default(0)
  enabled   Boolean     @default(true)
  orders    Order[]
  chatMessages OrderChat[]
  notifications Notification[]
}

model Sauce {
  id          Int         @id @default(autoincrement())
  description String
  name        String      @unique
  price       Float
  type        String      @default("sauce")
  image       String?
  available   Boolean     @default(true)
  ordre       String?
  platSauces  OrderItem[] @relation("PlatSauce")
  orderItems  OrderItem[]
  tags        Tags[]      @relation("SauceToTags")

  @@index([name])
  @@index([price])
}

model Tags {
  id           Int     @id @default(autoincrement())
  nom          String
  description  String
  emoji        String
  recherchable Boolean @default(false)
  extras       Extra[] @relation("ExtraToTags")
  plats        Plat[]  @relation("PlatToTags")
  sauces       Sauce[] @relation("SauceToTags")
  platVersions PlatVersion[] @relation("PlatVersionToTags")
}

model Ingredient {
  id                    Int                          @id @default(autoincrement())
  name                  String
  description           String?
  allergen              Boolean                      @default(false)
  removedFromOrderItems OrderItemRemovedIngredient[]
  plats                 PlatIngredient[]

  @@index([name])
}

model Extra {
  id                   Int              @id @default(autoincrement())
  nom                  String
  description          String
  price                Float
  available            Boolean          @default(true)
  availableForDelivery Boolean          @default(true)
  speciality           Boolean          @default(false)
  orderItems           OrderItem[]
  orderItemExtras      OrderItemExtra[] @relation("OrderItemExtras")
  tags                 Tags[]           @relation("ExtraToTags")
}

model PlatIngredient {
  id           Int        @id @default(autoincrement())
  platId       Int
  ingredientId Int
  removable    Boolean    @default(true)
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  plat         Plat       @relation(fields: [platId], references: [id], onDelete: Cascade)

  @@unique([platId, ingredientId])
  @@index([platId])
  @@index([ingredientId])
}

model Plat {
  id                   Int              @id @default(autoincrement())
  description          String
  name                 String           @unique
  price                Float
  ordre                String?
  image                String?
  available            Boolean          @default(true)
  availableForDelivery Boolean          @default(true)
  speciality           Boolean          @default(false)
  IncludesSauce        Boolean          @default(true)
  saucePrice           Float
  orderItems           OrderItem[]
  ingredients          PlatIngredient[]
  versions             PlatVersion[]
  tags                 Tags[]           @relation("PlatToTags")

  @@index([name])
  @@index([price])
}

model PlatVersion {
  id                   Int     @id @default(autoincrement())
  size                 String
  extraPrice           Float
  platId               Int
  plat                 Plat    @relation(fields: [platId], references: [id], onDelete: Cascade)
  image                String?
  tags                 Tags[]  @relation("PlatVersionToTags")

  @@unique([platId, size])
  @@index([size])
  @@index([platId])
}

model Order {
  id                      Int                  @id @default(autoincrement())
  userId                  Int?
  user                    User?                @relation(fields: [userId], references: [id])
  status                  Int                  @default(0)
  totalPrice              Float
  clientMessage           String?
  restaurantMessage       String?
  isViewed                Boolean              @default(false)
  OrderType            String               @default("takeout") // "takeout" or "delivery"
  takeoutTime             DateTime?
  createdAt               DateTime             @default(now())
  confirmedAt             DateTime?
  canceledAt              DateTime?
  preparationStartedAt    DateTime?
  completedAt             DateTime?
  items                   OrderItem[]
  statusHistory           OrderStatusHistory[]
  chatMessages            OrderChat[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderStatusHistory {
  id        Int      @id @default(autoincrement())
  orderId   Int
  status    String
  timestamp DateTime @default(now())
  notes     String?
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([timestamp])
}

model OrderItem {
  id                 Int                          @id @default(autoincrement())
  orderId            Int
  platId             Int?
  sauceId            Int?
  extraId            Int?
  versionSize        String?
  versionExtraPrice  Float                        @default(0)
  quantity           Int                          @default(1)
  unitPrice          Float
  totalPrice         Float
  isReady            Boolean                      @default(false)
  platSauceId        Int?
  platSaucePrice     Float                        @default(0)
  message            String?
  extra              Extra?                       @relation(fields: [extraId], references: [id])
  order              Order                        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  plat               Plat?                        @relation(fields: [platId], references: [id])
  platSauce          Sauce?                       @relation("PlatSauce", fields: [platSauceId], references: [id])
  sauce              Sauce?                       @relation(fields: [sauceId], references: [id])
  addedExtras        OrderItemExtra[]
  removedIngredients OrderItemRemovedIngredient[]

  @@index([orderId])
  @@index([platId])
  @@index([sauceId])
  @@index([extraId])
}

model OrderChat {
  id        Int      @id @default(autoincrement())
  orderId   Int
  senderId  Int?
  senderType String  // "client" or "shop"
  message   String
  timestamp DateTime @default(now())
  isRead    Boolean  @default(false)
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender    User?    @relation(fields: [senderId], references: [id])

  @@index([orderId])
  @@index([timestamp])
}

model OrderItemExtra {
  id          Int       @id @default(autoincrement())
  orderItemId Int
  extraId     Int
  quantity    Int       @default(1)
  price       Float
  extra       Extra     @relation("OrderItemExtras", fields: [extraId], references: [id])
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@unique([orderItemId, extraId])
  @@index([orderItemId])
  @@index([extraId])
}

model OrderItemRemovedIngredient {
  id           Int        @id @default(autoincrement())
  orderItemId  Int
  ingredientId Int
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  orderItem    OrderItem  @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@unique([orderItemId, ingredientId])
  @@index([orderItemId])
  @@index([ingredientId])
}

model Settings {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  type        String   @default("string") // "string", "boolean", "number", "time"
  description String?
  category    String   @default("general") // "general", "orders", "hours", "menu"
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([key])
  @@index([category])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String   // "chat", "order_status", "general"
  title     String
  message   String
  data      Json?    // Additional data like orderId, chatMessageId, etc.
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model OrderHours {
  id        Int      @id @default(autoincrement())
  time      String   // Format: "HH:MM"
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([time])
  @@index([time])
  @@index([enabled])
}
